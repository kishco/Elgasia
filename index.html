<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì—˜ê°€ì‹œì•„ - í…ìŠ¤íŠ¸ RPG 1.1</title>
  <style>
    body { font-family: 'Malgun Gothic', sans-serif; background: #232236; color: #fff; margin: 0; padding: 0;}
    #main { max-width: 900px; margin: 40px auto; background: #181828; padding: 30px; border-radius: 20px; box-shadow: 0 0 30px #0008;}
    .stat-box { margin: 12px 0 24px 0; }
    .stat-box span { display: inline-block; margin-right: 18px; font-size: 18px; }
    .btn-bar button { background: #384085; color: #fff; border: none; border-radius: 7px; margin: 4px; padding: 10px 20px; font-size: 17px; cursor: pointer; transition: background 0.15s;}
    .btn-bar button:disabled { background: #333; color: #aaa; cursor: not-allowed; }
    .equip-rare { color: #51cafc; } .equip-unique { color: #d76bff; } .equip-epic { color: #ff90b5; }
    .equip-legend { color: gold; } .equip-myth { color: #fa4242; font-weight: bold;}
    .equip-normal { color: #fff;}
    .log { border: 1px solid #222; background: #191934; margin: 16px 0; border-radius: 10px; min-height: 120px; padding: 14px; font-size:17px;}
    .section { margin: 20px 0 0 0; }
    .inv-btn { margin-left: 8px; background: #384085; color: #fff; border: none; border-radius: 5px; padding: 2px 9px; font-size: 14px;}
    .inv-btn:disabled { color: #888;}
    .equipitem { font-size: 15px;}
    .equip-bonus {font-size:14px;color:#b8ffad;}
    .namebox input { font-size:18px; padding:3px 8px; border-radius:7px; border:1px solid #555;}
    .save-bar button { background: #515b9d; color: #fff; border: none; border-radius: 6px; margin: 2px; padding: 7px 15px; font-size: 15px;}
    .save-slot-btn { background:#2e2e4e; color:#fff; margin:7px; padding:15px 30px; font-size:22px; border-radius:10px; border:none;}
    .shop-item { margin:8px 0; padding:12px; border-radius:10px; background: #21214a; box-shadow: 0 2px 8px #0003;}
    .shop-item .equip-bonus { color:#bbeeff; }
    .shop-title { color:#ffe680; font-size: 21px; margin-bottom:10px;}
    .enhance-btn { background: #1f8e26; color: #fff; margin-left:12px; border-radius:6px;}
    .fail-msg { color:#ff6161; font-weight:bold; }
    .succ-msg { color:#8aff8a; font-weight:bold; }
    .enh-lv { color:#e7e553; font-weight:bold;}
    .scroll-y { max-height:340px; overflow-y:auto;}
    .monname { color:#ffd700; font-weight:bold;}
    .save-del-btn { background:#a23c3c; color:#fff; border-radius:7px; border:none; font-size:14px; padding:4px 14px; margin-left:8px;}
    .ilv-txt { color:#9ed1f7; font-weight:bold; margin-right:8px; }
  </style>
</head>
<body>
<div id="main">
  <div id="loadslotbox"></div>
  <div id="userinfo" style="display:none"></div>
  <div class="btn-bar" id="menubar" style="display:none">
    <button onclick="action('hunt')">ì‚¬ëƒ¥</button>
    <button onclick="dungeonEnterUI()">ë˜ì „</button>
    <button onclick="showChar()">ìºë¦­í„°</button>
    <button onclick="showInv()">ì†Œì§€í’ˆ</button>
    <button onclick="showTown()">ë§ˆì„</button>
  </div>
  <div class="save-bar" id="savebar" style="display:none">
    <button onclick="saveGame()">ğŸ’¾ ì„¸ì´ë¸Œ</button>
    <button onclick="showLoad()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <span style="color:#aaa;">(ìŠ¬ë¡¯ <span id="slotsel"></span>)</span>
  </div>
  <div class="log" id="logbox"></div>
</div>
<script>
const statNames = ["STR", "DEX", "INT", "VIT", "LUK"];
const equipSlots = ["ë¬´ê¸°", "ë°©íŒ¨", "ë¨¸ë¦¬", "ìƒì˜", "í•˜ì˜", "ì‹ ë°œ", "ì†"];
const prefixes = ["ë¶ˆíƒ€ëŠ”", "ì‹ ì†í•œ", "ê³ ëŒ€ì˜", "ë¹›ë‚˜ëŠ”", "ê°•ì¸í•œ", "ì¬ë¹ ë¥¸", "í˜„ìì˜", "ì•”í‘ì˜", "ë‹¨ë‹¨í•œ", "ìš©ë§¹í•œ"];
const suffixes = ["ê´‘ê¸°", "ì§€í˜œ", "ì†ë„", "í–‰ìš´", "í˜", "ìˆ˜í˜¸", "íŒŒë©¸", "ë§ˆë²•", "ë¶ˆë©¸", "ìš©ê¸°"];
const rarityOrder = ["ì¼ë°˜","ë ˆì–´","ìœ ë‹ˆí¬","ì—í”½","ë ˆì „ë”ë¦¬","ìœ ì¼"];
const rarityColors = { "ì¼ë°˜":"equip-normal", "ë ˆì–´":"equip-rare", "ìœ ë‹ˆí¬":"equip-unique", "ì—í”½":"equip-epic", "ë ˆì „ë”ë¦¬":"equip-legend", "ìœ ì¼":"equip-myth" };
const rarityRate = [60,20,5,1,0.01,0];
const dungeonRate = [45,25,10,6,1,0.1];
const inventoryLimit = 40;
const skillTriggerRate = {
  "ì¼ë°˜": 0.05, "ë ˆì–´": 0.10, "ìœ ë‹ˆí¬": 0.15,
  "ì—í”½": 0.20, "ë ˆì „ë”ë¦¬": 0.30, "ìœ ì¼": 0.5
};
const slotTypePool = {
  "ë¬´ê¸°": [
    {name:"ê²€",type:"ê·¼ì ‘"}, {name:"ë„ë¼",type:"ê·¼ì ‘"}, {name:"ì°½",type:"ê·¼ì ‘"}, {name:"ë ˆì´í”¼ì–´",type:"ê·¼ì ‘"},
    {name:"ëŒ€ê²€",type:"ê·¼ì ‘"}, {name:"ì–‘ì†ë„ë¼",type:"ê·¼ì ‘"},
    {name:"í™œ",type:"ì›ê±°ë¦¬"}, {name:"ì„ê¶",type:"ì›ê±°ë¦¬"}, {name:"ì´",type:"ì›ê±°ë¦¬"},
    {name:"ì›ë“œ",type:"ë§ˆë²•"}, {name:"ìŠ¤íƒœí”„",type:"ë§ˆë²•"}, {name:"ë“€ì–¼ê±´",type:"ë§ˆë²•"}
  ],
  "ë°©íŒ¨": [{name:"ë°©íŒ¨",type:"ë°©ì–´"}],
  "ë¨¸ë¦¬": [{name:"íˆ¬êµ¬"},{name:"ëª¨ì"},{name:"ë‘ê±´"}],
  "ìƒì˜": [{name:"ê°‘ì˜·"},{name:"ë¡œë¸Œ"},{name:"ìì¼“"}],
  "í•˜ì˜": [{name:"ë°”ì§€"},{name:"ë ˆê¹…ìŠ¤"}],
  "ì‹ ë°œ": [{name:"ë¶€ì¸ "},{name:"ì‹ ë°œ"},{name:"ì¥í™”"}],
  "ì†": [{name:"ì¥ê°‘"},{name:"ë°˜ì§€"}]
};
const skillPool = {
  "ê·¼ì ‘": ["íšŒì „ë² ê¸°", "ì§€ì§„ê°•íƒ€", "ê´‘ì—­ì°¸ê²©", "ì°¸ê²©", "ëŒì§„ë² ê¸°"],
  "ì›ê±°ë¦¬": ["ì—°ì†ì‚¬ê²©", "ê´€í†µí™”ì‚´", "ì €ê²©", "í­ë°œí™”ì‚´", "ì§‘ì¤‘ì‚¬ê²©"],
  "ë§ˆë²•": ["íŒŒì´ì–´ë³¼", "ì•„ì´ìŠ¤ìŠ¤í†°", "ì²´ì¸ë¼ì´íŠ¸ë‹", "ì•”í‘êµ¬", "ì—ë„ˆì§€ë¸”ë˜ìŠ¤íŠ¸"]
};
const monsterNames = [
  "ê·¸ë¦¼ì ë©§ë¼ì§€", "ë¹™ê²° ìŠ¬ë¼ì„", "ë¶ˆì‚¬ë¥¸ í•´ê³¨ê¸°ì‚¬", "ì§€ì˜¥ë°•ì¥", "ëŒì—°ë³€ì´ ëŠ‘ëŒ€", "ì•”í‘ì˜ ê³ ë¸”ë¦°", "ê´‘ê¸°ì˜ ì˜¤ìš°ê±°", "ì„œë¦¬ê³¨ë ˜", "ë¶ˆê½ƒ ì™€ì´ë²ˆ", "ì£½ìŒì˜ ë¦¬ì¹˜", "í˜¼ëˆì˜ ë¯¸ë…¸íƒ€ìš°ë¥´ìŠ¤"
];
let user = null;
let saveSlot = 1;

window.onload = function() { renderSaveSlotSelect(); };
function renderSaveSlotSelect() {
  let html = `<div class="save-slot-select"><b>ë¶ˆëŸ¬ì˜¬ ìŠ¬ë¡¯ì„ ì„ íƒí•˜ì„¸ìš”</b><br>`;
  for(let i=1;i<=3;i++){
    let data = localStorage.getItem("elgasia_save_"+i);
    let btnText = data ? `ìŠ¬ë¡¯${i} (${JSON.parse(data).name} Lv.${JSON.parse(data).level})` : `ìŠ¬ë¡¯${i} (ìƒˆ ì‹œì‘)`;
    html += `<div style="margin-bottom:8px;display:flex;align-items:center;">
      <button class="save-slot-btn" onclick="startGame(${i})">${btnText}</button>
      <button class="save-del-btn" onclick="deleteSaveSlot(${i})">ì‚­ì œ</button>
    </div>`;
  }
  html += `</div>`;
  document.getElementById("loadslotbox").innerHTML = html;
}
function deleteSaveSlot(slot) {
  if(confirm(`ì •ë§ë¡œ ìŠ¬ë¡¯${slot}ì˜ ì €ì¥ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)){
    localStorage.removeItem("elgasia_save_"+slot);
    renderSaveSlotSelect();
  }
}
function saveGame() {
  if (!user) return;
  localStorage.setItem("elgasia_save_"+saveSlot, JSON.stringify(user));
  log(`<span style='color:#aaf'>ìŠ¬ë¡¯ ${saveSlot}ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</span>`);
}
function loadGame(slot) {
  let data = localStorage.getItem("elgasia_save_"+slot);
  if (data) {
    user = JSON.parse(data);
    saveSlot = slot;
    showUI();
    updateUser();
    log(`<span style='color:#aff'>ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ! ìŠ¬ë¡¯ ${slot}</span>`);
  }
}
function showLoad() {
  let html = `<b>ë¶ˆëŸ¬ì˜¬ ìŠ¬ë¡¯ ì„ íƒ</b><br>`;
  for(let i=1;i<=3;i++){
    let data = localStorage.getItem("elgasia_save_"+i);
    let btnText = data ? `ìŠ¬ë¡¯${i} ë¶ˆëŸ¬ì˜¤ê¸° (${JSON.parse(data).name} Lv.${JSON.parse(data).level})` : `ìŠ¬ë¡¯${i} (ë¹„ì–´ìˆìŒ)`;
    html += `<button class="save-slot-btn" onclick="loadGame(${i});hideLoad();">${btnText}</button>
    <button class="save-del-btn" onclick="deleteSaveSlot(${i})">ì‚­ì œ</button><br>`;
  }
  html += `<br><button class="inv-btn" onclick="hideLoad()">ë‹«ê¸°</button>`;
  document.getElementById("logbox").innerHTML = html;
}
function hideLoad(){ log('ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°'); }
function startGame(slot) {
  saveSlot = slot;
  let data = localStorage.getItem("elgasia_save_"+slot);
  if (data) {
    user = JSON.parse(data);
    showUI();
    updateUser();
    log(`<span style='color:#aff'>ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ! ìŠ¬ë¡¯ ${slot}</span>`);
  } else {
    user = {
      name: "ìš©ì‚¬", level: 1, exp: 0, rebirth: 0, gold: 100,
      stats: [1,1,1,1,1], statmax: 9999, hp: 30, maxhp: 30,
      equip: {}, inv: [], town: {restcount:0,skillstone:1}, stones: 0
    };
    showUI();
    updateUser();
    log(`<b>í™˜ì˜í•©ë‹ˆë‹¤! ìºë¦­í„° ì´ë¦„ì„ ë¨¼ì € ì •í•´ì£¼ì„¸ìš”.</b> <br><div class="namebox"><input type="text" id="newname" maxlength="10" placeholder="ìºë¦­í„° ì´ë¦„"/><button class="inv-btn" onclick="setCharName()">í™•ì¸</button></div>`);
  }
}
function showUI() {
  document.getElementById("loadslotbox").style.display = "none";
  document.getElementById("userinfo").style.display = "";
  document.getElementById("menubar").style.display = "";
  document.getElementById("savebar").style.display = "";
  document.getElementById("slotsel").innerText = saveSlot;
}
function setCharName() {
  let n = document.getElementById("newname").value.trim();
  if (!n) { alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
  user.name = n;
  updateUser();
  log(`ì´ë¦„ì´ <b>${n}</b>ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!`);
  saveGame();
}
function updateUser() {
  document.getElementById("userinfo").innerHTML = `<div class="stat-box">
    <span>ì´ë¦„ <b>${user.name}</b> <button class="inv-btn" onclick="promptNameChange()">ë³€ê²½</button></span>
    <span>ë ˆë²¨ <b>${user.level}</b></span>
    <span>ê²½í—˜ì¹˜ <b>${user.exp}/${expNeed(user.level)}</b></span>
    <span>í™˜ìƒ <b>${user.rebirth}</b></span>
    <span>ê³¨ë“œ <b>${user.gold}</b></span>
    <span>ê°•í™”ì„ <b>${user.stones||0}</b></span>
    <span>HP <b>${user.hp}/${user.maxhp}</b></span>
  </div>`;
  let disableCombat = (user.hp <= 1);
  document.querySelectorAll(".btn-bar button")[0].disabled = disableCombat; // ì‚¬ëƒ¥
  document.querySelectorAll(".btn-bar button")[1].disabled = disableCombat; // ë˜ì „
}
function expNeed(lv){ return Math.floor(Math.pow(lv,1.5)*12)+lv*8; }
function log(msg){ document.getElementById("logbox").innerHTML = msg; }
function promptNameChange() {
  log(`ìƒˆ ìºë¦­í„° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:<br>
    <div class="namebox"><input type="text" id="newname" maxlength="10" placeholder="ìºë¦­í„° ì´ë¦„"/><button class="inv-btn" onclick="setCharName()">í™•ì¸</button></div>
    <button class="inv-btn" onclick="updateUser();log('ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°');">ì·¨ì†Œ</button>`);
}
// --------------- ì‚¬ëƒ¥ ë° ë˜ì „ ë³´ìƒ(ëª¬ìŠ¤í„°, ê³¨ë“œ, ì•„ì´í…œ) ---------------
function action(type) {
  if(user.hp <= 1) {
    log("HPê°€ 1ì´ë¼ ì „íˆ¬ë¥¼ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤! <br>ë§ˆì„ì—ì„œ íœ´ì‹í•˜ì„¸ìš”.");
    updateUser();
    return;
  }
  if (type==='hunt') {
    let mon = monsterNames[rint(0,monsterNames.length-1)];
    let gain = Math.floor(user.level*1.5)+rint(4,12);
    let hpLoss = rint(3,8);
    let goldGain = rint(8,18) + Math.floor(user.level*1.2);
    user.exp += gain;
    user.hp -= hpLoss; if(user.hp<1){user.hp=1;}
    user.gold += goldGain;
    let dropMsg = "", stoneMsg="";
    if (Math.random() < 0.25) {
      let item = makeItem(false);
      if (addInv(item)) dropMsg = `<br>ì•„ì´í…œ íšë“! ${itemDisplay(item)}`;
    }
    if(Math.random()<0.10){
      user.stones=(user.stones||0)+1;
      stoneMsg=`<br><span style="color:#77e;">ê°•í™”ì„ 1ê°œë¥¼ íšë“í–ˆë‹¤!</span>`;
    }
    levelupCheck();
    log(`[ì‚¬ëƒ¥ ì„±ê³µ!] <span class="monname">${mon}</span>ì—ê²Œ ê²½í—˜ì¹˜ +${gain}, HP -${hpLoss}, ê³¨ë“œ +${goldGain}${dropMsg}${stoneMsg}`);
  }
  updateUser();
}
function dungeonEnterUI() {
  log(`<b>[ë˜ì „ ì…ì¥]</b><br>
  <span style="color:#ffd700;">ë˜ì „ì—ì„œ ì£½ìœ¼ë©´ í™•ë¥ ì ìœ¼ë¡œ ì¥ë¹„ë¥¼ ìƒì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span><br><br>
  <button class="inv-btn" onclick="dungeonAction()">ì…ì¥í•˜ê¸°</button>
  <button class="inv-btn" onclick="updateUser();log('ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°');">ì·¨ì†Œ</button>`);
}
function dungeonAction() {
  if(user.hp <= 1) {
    log("HPê°€ 1ì´ë¼ ì „íˆ¬ë¥¼ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤! <br>ë§ˆì„ì—ì„œ íœ´ì‹í•˜ì„¸ìš”."); updateUser(); return;
  }
  let mon = monsterNames[rint(0,monsterNames.length-1)];
  let gain = Math.floor(user.level*4)+rint(18,30);
  let hpLoss = rint(13,26);
  let goldGain = rint(32,80) + Math.floor(user.level*4.2);
  user.exp += gain;
  user.hp -= hpLoss; if(user.hp<1){user.hp=0;}
  user.gold += goldGain;
  let dropMsg = "", stoneMsg="", uniqueMsg="", loseMsg = "";
  let itemGot = null;
  if (Math.random() < 0.5) {
    let item = makeItem(true);
    if (addInv(item)) {
      dropMsg = `<br>ì•„ì´í…œ íšë“! ${itemDisplay(item)}`;
      if(item.rarity=="ìœ ì¼") uniqueMsg = "<br><span style='color:#fa4242;'>ìœ ì¼ ë“±ê¸‰ ì•„ì´í…œ(ë˜ëŠ” ëª¬ìŠ¤í„°) ì¡°ìš°!</span>";
      itemGot = item;
    }
  }
  if(Math.random()<0.15){
    user.stones=(user.stones||0)+1;
    stoneMsg=`<br><span style="color:#77e;">ê°•í™”ì„ 1ê°œë¥¼ íšë“í–ˆë‹¤!</span>`;
  }
  if(user.hp<=0){
    user.hp=1;
    let lost = [];
    if(Math.random()<0.2){
      let candidates = equipSlots.filter(s=>user.equip[s]);
      if(candidates.length){
        let lostSlot = candidates[rint(0,candidates.length-1)];
        let lostItem = user.equip[lostSlot];
        user.equip[lostSlot] = undefined;
        lost.push(lostItem.name);
      }
    }
    loseMsg = `<br><span class="fail-msg">[ì‚¬ë§] ${lost.length?'ì¥ë¹„ ì†ì‹¤: '+lost.join(", "):'HP 1ë¡œ ë³µê·€'}</span>`;
    log(`[ë˜ì „] <span class="monname">${mon}</span>ì™€ì˜ ì „íˆ¬ì—ì„œ íŒ¨ë°°!<br>HP 1ë¡œ ë³µê·€.${loseMsg}`);
  }else{
    log(`[ë˜ì „] <span class="monname">${mon}</span>ì™€ì˜ ì „íˆ¬ ê²°ê³¼<br>
      ê²½í—˜ì¹˜ +${gain}, HP -${hpLoss}, ê³¨ë“œ +${goldGain}${dropMsg}${stoneMsg}${uniqueMsg}`);
  }
  updateUser();
}
function levelupCheck(){
  while(user.exp>=expNeed(user.level) && user.level<999){
    user.exp -= expNeed(user.level);
    user.level++;
    statRandAdd(user.stats);
    user.maxhp += 5+rint(0,5);
    user.hp = user.maxhp;
    log(`[LEVEL UP!] Lv.${user.level}ë¡œ ì˜¬ëìŠµë‹ˆë‹¤!`);
  }
}
function statRandAdd(stats){
  let idx = rint(0,stats.length-1);
  stats[idx]++;
}
function rint(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function makeItem(allowMyth) {
  let rate = allowMyth ? dungeonRate : rarityRate;
  let r = Math.random() * 100;
  let rarity = "ì¼ë°˜";
  let acc = 0;
  for (let i=0;i<rate.length;i++) {
    acc += rate[i];
    if (r < acc) { rarity = rarityOrder[i]; break; }
  }
  let slot = equipSlots[rint(0, equipSlots.length-1)];
  let pool = slotTypePool[slot];
  let baseObj = pool[rint(0, pool.length-1)];
  let itemType = baseObj.name;
  let itemAttackType = baseObj.type || null;
  let prefix = prefixes[rint(0,prefixes.length-1)];
  let suffix = suffixes[rint(0,suffixes.length-1)];
  let name = "";
  let itemLevel = Math.max(1, Math.round(user.level * (0.7 + Math.random()*0.4)));
  if (rarity === "ìœ ì¼") {
    name = makeMythicName();
    prefix = null; suffix = null;
  } else {
    name = `${prefix} ${suffix}ì˜ ${itemType}`;
  }
  let skillBase = null, skill = null;
  if (itemAttackType && skillPool[itemAttackType]) {
    skillBase = skillPool[itemAttackType][rint(0, skillPool[itemAttackType].length-1)];
    skill = prefix ? `${prefix} ${skillBase}` : skillBase;
  }
  let stat = [];
  let bonus = rarityBonus(rarity) + Math.floor(itemLevel/9);
  for (let i=0;i<5;i++) stat.push(rint(0, (i===0?4:2) + bonus));
  let atk=0, ratk=0, matk=0;
  if(itemAttackType=="ê·¼ì ‘") atk = rint(2, 8+bonus*2);
  if(itemAttackType=="ì›ê±°ë¦¬") ratk = rint(2, 8+bonus*2);
  if(itemAttackType=="ë§ˆë²•") matk = rint(2, 8+bonus*2);
  let skillBonus = 1;
  if(prefix && prefix.includes("ë¶ˆíƒ€ëŠ”")) skillBonus = 1.2;
  let trigger = skillTriggerRate[rarity] || 0.05;
  stat.push(Math.floor(atk * skillBonus));
  stat.push(Math.floor(ratk * skillBonus));
  stat.push(Math.floor(matk * skillBonus));
  return {
    name: name,
    rarity: rarity,
    slot: slot,
    stat: stat,
    type: itemType,
    attackType: itemAttackType,
    skill: skill,
    skillBase: skillBase,
    skillBonus: skillBonus,
    skillTrigger: trigger,
    enh: 0,
    itemLevel: itemLevel
  };
}
function makeMythicName(){
  const mythPrefix = ["ì•„ë¥´ì¹´ë‚˜ì˜", "ë£¬ì˜", "ìŠí˜€ì§„", "ì¹¼ë¦¬ë²„", "ë“œë˜ê³¤ì˜", "ìš´ëª…ì˜", "ì™•ì˜", "ì¹´ì˜¤ìŠ¤", "ì€í•˜ìˆ˜ì˜"];
  const mythMain = ["ì‹¬íŒì", "ì „ì„¤", "ì°½ì¡°ì", "íŒŒë©¸ì", "ìˆ˜í˜¸ì", "ì‹¬ì—°", "ì˜í˜¼", "ì—¬ëª…", "ë¶„ë…¸"];
  return `${mythPrefix[rint(0,mythPrefix.length-1)]} ${mythMain[rint(0,mythMain.length-1)]}`;
}
function rarityBonus(rarity){
  switch(rarity){
    case "ì¼ë°˜": return 1;
    case "ë ˆì–´": return 2;
    case "ìœ ë‹ˆí¬": return 3;
    case "ì—í”½": return 4;
    case "ë ˆì „ë”ë¦¬": return 6;
    case "ìœ ì¼": return 10;
  }
  return 1;
}
function showChar() {
  let eqhtml = "";
  for(let slot of equipSlots){
    let eq = user.equip[slot];
    if(eq){
      eqhtml += `<div><b>${slot}:</b> <span class="ilv-txt">Lv.${eq.itemLevel||1}</span><span class="${rarityColors[eq.rarity]}">${enhanceLabel(eq)}${eq.name}</span> <span class="equip-bonus">[${itemStatDisplay(eq)}]</span>
      <button class="inv-btn" onclick="unequip('${slot}')">í•´ì œ</button><button class="enhance-btn" onclick="showEnhance('equip','${slot}')">ê°•í™”</button></div>`;
    } else {
      eqhtml += `<div><b>${slot}:</b> <span style="color:#888">ë¹„ì–´ìˆìŒ</span></div>`;
    }
  }
  let weaponInfo = "";
  let weapon = user.equip["ë¬´ê¸°"];
  if(weapon){
    weaponInfo = `<br><b>ğŸ—¡ï¸ ì¥ì°© ë¬´ê¸°: ${enhanceLabel(weapon)}${weapon.name} (${weapon.type})</b>
    <br>ğŸ’¡ <b>ìŠ¤í‚¬:</b> <span style="color:#ffd700">${weapon.skill || '-'}</span>
    <br><b>ìŠ¤í‚¬ ë°œë™ í™•ë¥ :</b> ${(weapon.skillTrigger*100).toFixed(0)}%
    <br><b>ê³µê²©ë ¥ ì¢…ë¥˜:</b> ${weapon.attackType=="ê·¼ì ‘"?"ATK":weapon.attackType=="ì›ê±°ë¦¬"?"RATK":"MATK"}${weapon.skillBonus>1?" <span style='color:#ff5858'>[ì†ì„± ê°•í™”]</span>":""}`;
  }else{
    weaponInfo = "<br><b>ì¥ì°© ë¬´ê¸° ì—†ìŒ</b>";
  }
  log(`<b>[ìºë¦­í„°]</b><br>
    <b>ë ˆë²¨:</b> ${user.level} / <b>í™˜ìƒ:</b> ${user.rebirth} / <b>ê²½í—˜ì¹˜:</b> ${user.exp}/${expNeed(user.level)}<br>
    <b>ìŠ¤íƒ¯:</b> ${user.stats.map((s,i)=>`${statNames[i]}:${s}`).join(" / ")}<br>
    <b>HP:</b> ${user.hp}/${user.maxhp}<br>
    <b>ì¥ì°©ì¥ë¹„</b><br><div class="scroll-y">${eqhtml}</div>
    ${weaponInfo}
    <br><button class="inv-btn" onclick="updateUser();log('ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°');">ë‹«ê¸°</button>
  `);
}
function enhanceLabel(item) {
  return item.enh && item.enh > 0 ? `<span class="enh-lv">+${item.enh}</span> ` : '';
}
function unequip(slot) {
  if (!user.equip[slot]) return;
  addInv(user.equip[slot]);
  user.equip[slot] = undefined;
  showChar();
}
function showInv() {
  let invhtml = "";
  user.inv.forEach((item,i)=>{
    if(item.type){
      invhtml += `<div class="equipitem"><span class="ilv-txt">Lv.${item.itemLevel||1}</span><span class="${rarityColors[item.rarity]}">${enhanceLabel(item)}${item.name}</span>
      <span class="equip-bonus">[${itemStatDisplay(item)}]</span>
      <button class="inv-btn" onclick="equipItem(${i})">ì°©ìš©</button>
      <button class="inv-btn" onclick="removeInv(${i})">ë²„ë¦¬ê¸°</button>
      <button class="enhance-btn" onclick="showEnhance('inv',${i})">ê°•í™”</button></div>`;
    } else {
      invhtml += `<div class="equipitem">${item.name || "ì•„ì´í…œ"}
      <button class="inv-btn" onclick="removeInv(${i})">ë²„ë¦¬ê¸°</button></div>`;
    }
  });
  if(!invhtml) invhtml="<div style='color:#888'>ì†Œì§€í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>";
  log(`<b>[ì†Œì§€í’ˆ]</b> (${user.inv.length}/${inventoryLimit})<br><div class="scroll-y">${invhtml}</div>
    <button class="inv-btn" onclick="updateUser();log('ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°');">ë‹«ê¸°</button>`);
}
function removeInv(idx){ user.inv.splice(idx,1); showInv(); }
function equipItem(idx){
  let item=user.inv[idx];
  if(!item) return;
  if(user.equip[item.slot]) addInv(user.equip[item.slot]);
  user.equip[item.slot]=item;
  user.inv.splice(idx,1);
  showInv(); updateUser();
}
function addInv(item){
  if(user.inv.length>=inventoryLimit){log("ì†Œì§€í’ˆì´ ê°€ë“ ì°¼ë‹¤!"); return false;}
  user.inv.push(item); return true;
}
function itemDisplay(item){
  return `<span class="ilv-txt">Lv.${item.itemLevel||1}</span><span class="${rarityColors[item.rarity]}">${enhanceLabel(item)}${item.name}</span> <span class="equip-bonus">[${itemStatDisplay(item)}]</span>`;
}
function itemStatDisplay(item){
  let arr = [];
  for(let i=0;i<5;i++) arr.push(`${statNames[i]}+${item.stat[i]}`);
  arr.push(`ATK+${item.stat[5]}`);
  arr.push(`RATK+${item.stat[6]}`);
  arr.push(`MATK+${item.stat[7]}`);
  if(item.enh && item.enh>0) arr.push(`ê°•í™”:${item.enh}`);
  return arr.join(' / ');
}
function showEnhance(where, arg) {
  let item;
  if(where=='inv') item = user.inv[arg];
  else if(where=='equip') item = user.equip[arg];
  if(!item || !item.type) return;
  let enh = item.enh || 0;
  let needStone = enhanceStoneNeed(enh+1);
  let prob = enhanceProb(enh+1);
  let msg = `<b>${enhanceLabel(item)}${item.name}</b><br>
    í˜„ì¬ ê°•í™”: <span class="enh-lv">${enh}ê°•</span><br>
    <b>ë‹¤ìŒ ê°•í™”(+${enh+1}ê°•)</b><br>
    í•„ìš” ê°•í™”ì„: <b>${needStone}</b> (ë³´ìœ : ${user.stones||0})<br>
    ì„±ê³µ í™•ë¥ : <b>${(prob*100).toFixed(1)}%</b><br>
    <button class="enhance-btn" onclick="doEnhance('${where}',${JSON.stringify(arg)})">ê°•í™” ì‹œë„</button>
    <button class="inv-btn" onclick="updateUser();log('ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°');">ì·¨ì†Œ</button>
    <div style="margin-top:14px;color:#aaa;font-size:13px;">* ì‹¤íŒ¨ì‹œ ì•„ì´í…œì€ íŒŒê´´ë©ë‹ˆë‹¤.</div>`;
  log(msg);
}
function enhanceStoneNeed(lv) {
  if(lv<=0) return 0;
  if(lv==1) return 1;
  if(lv==2) return 2;
  if(lv==3) return 4;
  if(lv==4) return 8;
  if(lv>=5 && lv<10) return 20*Math.pow(2,lv-5);
  if(lv>=10 && lv<15) return 20*Math.pow(2,5)*Math.pow(3,lv-10);
  if(lv>=15) return 20*Math.pow(2,5)*Math.pow(3,5)*Math.pow(4,lv-15);
  return 999999;
}
function enhanceProb(lv) {
  if(lv<=4) return 1;
  if(lv<=6) return 0.4;
  if(lv<=8) return 0.2;
  if(lv<=10) return 0.1;
  if(lv<=12) return 0.05;
  if(lv<=14) return 0.025;
  if(lv<=16) return 0.01;
  if(lv<=18) return 0.007;
  if(lv==19) return 0.004;
  if(lv==20) return 0.002;
  return 0;
}
function doEnhance(where, arg) {
  let item;
  if(where=='inv') item = user.inv[arg];
  else if(where=='equip') item = user.equip[arg];
  if(!item || !item.type) return;
  let enh = item.enh || 0;
  let needStone = enhanceStoneNeed(enh+1);
  let prob = enhanceProb(enh+1);
  if((user.stones||0)<needStone){
    log(`<span class="fail-msg">ê°•í™”ì„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (${needStone} í•„ìš”)</span>`);
    return;
  }
  if(enh>=20){
    log(`<span class="fail-msg">ìµœëŒ€ +20ê°•ì…ë‹ˆë‹¤.</span>`);
    return;
  }
  user.stones -= needStone;
  if(Math.random()<prob){
    item.enh = (item.enh||0)+1;
    for(let i=0;i<item.stat.length;i++){
      item.stat[i] += Math.max(1,Math.floor((item.enh)/3));
    }
    log(`<span class="succ-msg">ê°•í™” ì„±ê³µ! +${item.enh}ê°•ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!</span>`);
  }else{
    if(where=='inv') user.inv.splice(arg,1);
    else if(where=='equip') user.equip[arg]=undefined;
    log(`<span class="fail-msg">ê°•í™” ì‹¤íŒ¨! ì•„ì´í…œì´ íŒŒê´´ë˜ì—ˆìŠµë‹ˆë‹¤!</span>`);
  }
  updateUser();
}
function showShop() {
  let html = `<div class="shop-title">ì¥ë¹„ìƒì  - íŒë§¤(ê³¨ë“œ íšë“)</div>
  <div class="scroll-y">`;
  for(let slot of equipSlots){
    let eq = user.equip[slot];
    if(eq){
      html += `<div class="shop-item"><b>[${slot}]</b> <span class="ilv-txt">Lv.${eq.itemLevel||1}</span><span class="${rarityColors[eq.rarity]}">${enhanceLabel(eq)}${eq.name}</span>
      <span class="equip-bonus">[${itemStatDisplay(eq)}]</span>
      <button class="inv-btn" onclick="sellItem('equip','${slot}')">íŒë§¤</button></div>`;
    }
  }
  user.inv.forEach((item,i)=>{
    if(item.type){
      html += `<div class="shop-item"><span class="ilv-txt">Lv.${item.itemLevel||1}</span><span class="${rarityColors[item.rarity]}">${enhanceLabel(item)}${item.name}</span>
      <span class="equip-bonus">[${itemStatDisplay(item)}]</span>
      <button class="inv-btn" onclick="sellItem('inv',${i})">íŒë§¤</button></div>`;
    }
  });
  html += `</div><br><button class="inv-btn" onclick="showTown()">ë§ˆì„ë¡œ ëŒì•„ê°€ê¸°</button>`;
  log(html);
}
function sellItem(where, arg) {
  let item;
  if(where=='inv') item = user.inv[arg];
  else if(where=='equip') item = user.equip[arg];
  if(!item || !item.type) return;
  let gold = calcSellGold(item);
  if(where=='inv') user.inv.splice(arg,1);
  else if(where=='equip') user.equip[arg]=undefined;
  user.gold += gold;
  updateUser();
  log(`<span class="succ-msg">${enhanceLabel(item)}${item.name}ì„(ë¥¼) íŒë§¤í•˜ê³  <b>${gold}ê³¨ë“œ</b>ë¥¼ íšë“!</span>`);
  setTimeout(showShop, 1200);
}
function calcSellGold(item){
  let base = 20 + item.stat.reduce((a,b)=>a+b,0)*6 + (item.enh||0)*50 + (item.itemLevel||1)*10;
  switch(item.rarity){
    case "ë ˆì–´": base*=2; break;
    case "ìœ ë‹ˆí¬": base*=3; break;
    case "ì—í”½": base*=5; break;
    case "ë ˆì „ë”ë¦¬": base*=10; break;
    case "ìœ ì¼": base*=30; break;
  }
  return Math.floor(base);
}
function showTown(){
  log(`<b>[ë§ˆì„]</b><br>
    <button class="inv-btn" onclick="innRest()">ì—¬ê´€(íœ´ì‹)</button>
    <button class="inv-btn" onclick="showShop()">ì¥ë¹„ìƒì (íŒë§¤)</button>
    <button class="inv-btn" onclick="rebirth()">í™˜ìƒì˜ ì§‘</button>
    <button class="inv-btn" onclick="updateUser();log('ì´ì „ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°');">ë‹«ê¸°</button>`);
}
function innRest(){
  let cost=20+user.level*5;
  if(user.gold<cost){log("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");return;}
  user.gold-=cost; user.hp=user.maxhp;
  log(`ì—¬ê´€ì—ì„œ íœ´ì‹ í›„ HP ì „ë¶€ íšŒë³µ! (${cost}ê³¨ë“œ ì†Œëª¨)<br><button class='inv-btn' onclick='showTown()'>ëŒì•„ê°€ê¸°</button>`);
  updateUser();
}
function rebirth(){
  if(user.level<999){log("ë ˆë²¨ 999 ë‹¬ì„± ì‹œì—ë§Œ í™˜ìƒ ê°€ëŠ¥!<br><button class='inv-btn' onclick='showTown()'>ëŒì•„ê°€ê¸°</button>");return;}
  if(!confirm("í™˜ìƒ ì‹œ ë ˆë²¨/ìŠ¤íƒ¯/ì¥ë¹„ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?")) return;
  user.level=1; user.exp=0; user.gold=100;
  user.stats=user.stats.map(x=>1+user.rebirth*10);
  user.statmax=9999; user.rebirth+=1; user.hp=30; user.maxhp=30; user.equip={}; user.inv=[]; user.stones=0;
  log("í™˜ìƒ ì™„ë£Œ! ê¸°ë³¸ ëŠ¥ë ¥ì¹˜ +10ì´ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.<br><button class='inv-btn' onclick='showTown()'>ëŒì•„ê°€ê¸°</button>");
  updateUser();
}
</script>
</body>
</html>
