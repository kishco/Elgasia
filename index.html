<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>엘가시아 - 텍스트 RPG 1.1</title>
  <style>
    body { font-family: 'Malgun Gothic', sans-serif; background: #232236; color: #fff; margin: 0; padding: 0;}
    #main { max-width: 900px; margin: 40px auto; background: #181828; padding: 30px; border-radius: 20px; box-shadow: 0 0 30px #0008;}
    .stat-box { margin: 12px 0 24px 0; }
    .stat-box span { display: inline-block; margin-right: 18px; font-size: 18px; }
    .btn-bar button { background: #384085; color: #fff; border: none; border-radius: 7px; margin: 4px; padding: 10px 20px; font-size: 17px; cursor: pointer; transition: background 0.15s;}
    .btn-bar button:disabled { background: #333; color: #aaa; cursor: not-allowed; }
    .equip-rare { color: #51cafc; } .equip-unique { color: #d76bff; } .equip-epic { color: #ff90b5; }
    .equip-legend { color: gold; } .equip-myth { color: #fa4242; font-weight: bold;}
    .equip-normal { color: #fff;}
    .log { border: 1px solid #222; background: #191934; margin: 16px 0; border-radius: 10px; min-height: 120px; padding: 14px; font-size:17px;}
    .section { margin: 20px 0 0 0; }
    .inv-btn { margin-left: 8px; background: #384085; color: #fff; border: none; border-radius: 5px; padding: 2px 9px; font-size: 14px;}
    .inv-btn:disabled { color: #888;}
    .equipitem { font-size: 15px;}
    .equip-bonus {font-size:14px;color:#b8ffad;}
    .namebox input { font-size:18px; padding:3px 8px; border-radius:7px; border:1px solid #555;}
    .save-bar button { background: #515b9d; color: #fff; border: none; border-radius: 6px; margin: 2px; padding: 7px 15px; font-size: 15px;}
    .save-slot-btn { background:#2e2e4e; color:#fff; margin:7px; padding:15px 30px; font-size:22px; border-radius:10px; border:none;}
    .shop-item { margin:8px 0; padding:12px; border-radius:10px; background: #21214a; box-shadow: 0 2px 8px #0003;}
    .shop-item .equip-bonus { color:#bbeeff; }
    .shop-title { color:#ffe680; font-size: 21px; margin-bottom:10px;}
    .enhance-btn { background: #1f8e26; color: #fff; margin-left:12px; border-radius:6px;}
    .fail-msg { color:#ff6161; font-weight:bold; }
    .succ-msg { color:#8aff8a; font-weight:bold; }
    .enh-lv { color:#e7e553; font-weight:bold;}
    .scroll-y { max-height:340px; overflow-y:auto;}
    .monname { color:#ffd700; font-weight:bold;}
    .save-del-btn { background:#a23c3c; color:#fff; border-radius:7px; border:none; font-size:14px; padding:4px 14px; margin-left:8px;}
    .ilv-txt { color:#9ed1f7; font-weight:bold; margin-right:8px; }
  </style>
</head>
<body>
<div id="main">
  <div id="loadslotbox"></div>
  <div id="userinfo" style="display:none"></div>
  <div class="btn-bar" id="menubar" style="display:none">
    <button onclick="action('hunt')">사냥</button>
    <button onclick="dungeonEnterUI()">던전</button>
    <button onclick="showChar()">캐릭터</button>
    <button onclick="showInv()">소지품</button>
    <button onclick="showTown()">마을</button>
  </div>
  <div class="save-bar" id="savebar" style="display:none">
    <button onclick="saveGame()">💾 세이브</button>
    <button onclick="showLoad()">불러오기</button>
    <span style="color:#aaa;">(슬롯 <span id="slotsel"></span>)</span>
  </div>
  <div class="log" id="logbox"></div>
</div>
<script>
const statNames = ["STR", "DEX", "INT", "VIT", "LUK"];
const equipSlots = ["무기", "방패", "머리", "상의", "하의", "신발", "손"];
const prefixes = ["불타는", "신속한", "고대의", "빛나는", "강인한", "재빠른", "현자의", "암흑의", "단단한", "용맹한"];
const suffixes = ["광기", "지혜", "속도", "행운", "힘", "수호", "파멸", "마법", "불멸", "용기"];
const rarityOrder = ["일반","레어","유니크","에픽","레전더리","유일"];
const rarityColors = { "일반":"equip-normal", "레어":"equip-rare", "유니크":"equip-unique", "에픽":"equip-epic", "레전더리":"equip-legend", "유일":"equip-myth" };
const rarityRate = [60,20,5,1,0.01,0];
const dungeonRate = [45,25,10,6,1,0.1];
const inventoryLimit = 40;
const skillTriggerRate = {
  "일반": 0.05, "레어": 0.10, "유니크": 0.15,
  "에픽": 0.20, "레전더리": 0.30, "유일": 0.5
};
const slotTypePool = {
  "무기": [
    {name:"검",type:"근접"}, {name:"도끼",type:"근접"}, {name:"창",type:"근접"}, {name:"레이피어",type:"근접"},
    {name:"대검",type:"근접"}, {name:"양손도끼",type:"근접"},
    {name:"활",type:"원거리"}, {name:"석궁",type:"원거리"}, {name:"총",type:"원거리"},
    {name:"원드",type:"마법"}, {name:"스태프",type:"마법"}, {name:"듀얼건",type:"마법"}
  ],
  "방패": [{name:"방패",type:"방어"}],
  "머리": [{name:"투구"},{name:"모자"},{name:"두건"}],
  "상의": [{name:"갑옷"},{name:"로브"},{name:"자켓"}],
  "하의": [{name:"바지"},{name:"레깅스"}],
  "신발": [{name:"부츠"},{name:"신발"},{name:"장화"}],
  "손": [{name:"장갑"},{name:"반지"}]
};
const skillPool = {
  "근접": ["회전베기", "지진강타", "광역참격", "참격", "돌진베기"],
  "원거리": ["연속사격", "관통화살", "저격", "폭발화살", "집중사격"],
  "마법": ["파이어볼", "아이스스톰", "체인라이트닝", "암흑구", "에너지블래스트"]
};
const monsterNames = [
  "그림자 멧돼지", "빙결 슬라임", "불사른 해골기사", "지옥박쥐", "돌연변이 늑대", "암흑의 고블린", "광기의 오우거", "서리골렘", "불꽃 와이번", "죽음의 리치", "혼돈의 미노타우르스"
];
let user = null;
let saveSlot = 1;

window.onload = function() { renderSaveSlotSelect(); };
function renderSaveSlotSelect() {
  let html = `<div class="save-slot-select"><b>불러올 슬롯을 선택하세요</b><br>`;
  for(let i=1;i<=3;i++){
    let data = localStorage.getItem("elgasia_save_"+i);
    let btnText = data ? `슬롯${i} (${JSON.parse(data).name} Lv.${JSON.parse(data).level})` : `슬롯${i} (새 시작)`;
    html += `<div style="margin-bottom:8px;display:flex;align-items:center;">
      <button class="save-slot-btn" onclick="startGame(${i})">${btnText}</button>
      <button class="save-del-btn" onclick="deleteSaveSlot(${i})">삭제</button>
    </div>`;
  }
  html += `</div>`;
  document.getElementById("loadslotbox").innerHTML = html;
}
function deleteSaveSlot(slot) {
  if(confirm(`정말로 슬롯${slot}의 저장 데이터를 삭제하시겠습니까? 복구할 수 없습니다.`)){
    localStorage.removeItem("elgasia_save_"+slot);
    renderSaveSlotSelect();
  }
}
function saveGame() {
  if (!user) return;
  localStorage.setItem("elgasia_save_"+saveSlot, JSON.stringify(user));
  log(`<span style='color:#aaf'>슬롯 ${saveSlot}에 저장되었습니다!</span>`);
}
function loadGame(slot) {
  let data = localStorage.getItem("elgasia_save_"+slot);
  if (data) {
    user = JSON.parse(data);
    saveSlot = slot;
    showUI();
    updateUser();
    log(`<span style='color:#aff'>불러오기 완료! 슬롯 ${slot}</span>`);
  }
}
function showLoad() {
  let html = `<b>불러올 슬롯 선택</b><br>`;
  for(let i=1;i<=3;i++){
    let data = localStorage.getItem("elgasia_save_"+i);
    let btnText = data ? `슬롯${i} 불러오기 (${JSON.parse(data).name} Lv.${JSON.parse(data).level})` : `슬롯${i} (비어있음)`;
    html += `<button class="save-slot-btn" onclick="loadGame(${i});hideLoad();">${btnText}</button>
    <button class="save-del-btn" onclick="deleteSaveSlot(${i})">삭제</button><br>`;
  }
  html += `<br><button class="inv-btn" onclick="hideLoad()">닫기</button>`;
  document.getElementById("logbox").innerHTML = html;
}
function hideLoad(){ log('이전 화면으로 돌아감'); }
function startGame(slot) {
  saveSlot = slot;
  let data = localStorage.getItem("elgasia_save_"+slot);
  if (data) {
    user = JSON.parse(data);
    showUI();
    updateUser();
    log(`<span style='color:#aff'>불러오기 완료! 슬롯 ${slot}</span>`);
  } else {
    user = {
      name: "용사", level: 1, exp: 0, rebirth: 0, gold: 100,
      stats: [1,1,1,1,1], statmax: 9999, hp: 30, maxhp: 30,
      equip: {}, inv: [], town: {restcount:0,skillstone:1}, stones: 0
    };
    showUI();
    updateUser();
    log(`<b>환영합니다! 캐릭터 이름을 먼저 정해주세요.</b> <br><div class="namebox"><input type="text" id="newname" maxlength="10" placeholder="캐릭터 이름"/><button class="inv-btn" onclick="setCharName()">확인</button></div>`);
  }
}
function showUI() {
  document.getElementById("loadslotbox").style.display = "none";
  document.getElementById("userinfo").style.display = "";
  document.getElementById("menubar").style.display = "";
  document.getElementById("savebar").style.display = "";
  document.getElementById("slotsel").innerText = saveSlot;
}
function setCharName() {
  let n = document.getElementById("newname").value.trim();
  if (!n) { alert("이름을 입력해주세요."); return; }
  user.name = n;
  updateUser();
  log(`이름이 <b>${n}</b>으로 설정되었습니다!`);
  saveGame();
}
function updateUser() {
  document.getElementById("userinfo").innerHTML = `<div class="stat-box">
    <span>이름 <b>${user.name}</b> <button class="inv-btn" onclick="promptNameChange()">변경</button></span>
    <span>레벨 <b>${user.level}</b></span>
    <span>경험치 <b>${user.exp}/${expNeed(user.level)}</b></span>
    <span>환생 <b>${user.rebirth}</b></span>
    <span>골드 <b>${user.gold}</b></span>
    <span>강화석 <b>${user.stones||0}</b></span>
    <span>HP <b>${user.hp}/${user.maxhp}</b></span>
  </div>`;
  let disableCombat = (user.hp <= 1);
  document.querySelectorAll(".btn-bar button")[0].disabled = disableCombat; // 사냥
  document.querySelectorAll(".btn-bar button")[1].disabled = disableCombat; // 던전
}
function expNeed(lv){ return Math.floor(Math.pow(lv,1.5)*12)+lv*8; }
function log(msg){ document.getElementById("logbox").innerHTML = msg; }
function promptNameChange() {
  log(`새 캐릭터 이름을 입력하세요:<br>
    <div class="namebox"><input type="text" id="newname" maxlength="10" placeholder="캐릭터 이름"/><button class="inv-btn" onclick="setCharName()">확인</button></div>
    <button class="inv-btn" onclick="updateUser();log('이전 화면으로 돌아감');">취소</button>`);
}
// --------------- 사냥 및 던전 보상(몬스터, 골드, 아이템) ---------------
function action(type) {
  if(user.hp <= 1) {
    log("HP가 1이라 전투를 할 수 없습니다! <br>마을에서 휴식하세요.");
    updateUser();
    return;
  }
  if (type==='hunt') {
    let mon = monsterNames[rint(0,monsterNames.length-1)];
    let gain = Math.floor(user.level*1.5)+rint(4,12);
    let hpLoss = rint(3,8);
    let goldGain = rint(8,18) + Math.floor(user.level*1.2);
    user.exp += gain;
    user.hp -= hpLoss; if(user.hp<1){user.hp=1;}
    user.gold += goldGain;
    let dropMsg = "", stoneMsg="";
    if (Math.random() < 0.25) {
      let item = makeItem(false);
      if (addInv(item)) dropMsg = `<br>아이템 획득! ${itemDisplay(item)}`;
    }
    if(Math.random()<0.10){
      user.stones=(user.stones||0)+1;
      stoneMsg=`<br><span style="color:#77e;">강화석 1개를 획득했다!</span>`;
    }
    levelupCheck();
    log(`[사냥 성공!] <span class="monname">${mon}</span>에게 경험치 +${gain}, HP -${hpLoss}, 골드 +${goldGain}${dropMsg}${stoneMsg}`);
  }
  updateUser();
}
function dungeonEnterUI() {
  log(`<b>[던전 입장]</b><br>
  <span style="color:#ffd700;">던전에서 죽으면 확률적으로 장비를 잃을 수 있습니다.</span><br><br>
  <button class="inv-btn" onclick="dungeonAction()">입장하기</button>
  <button class="inv-btn" onclick="updateUser();log('이전 화면으로 돌아감');">취소</button>`);
}
function dungeonAction() {
  if(user.hp <= 1) {
    log("HP가 1이라 전투를 할 수 없습니다! <br>마을에서 휴식하세요."); updateUser(); return;
  }
  let mon = monsterNames[rint(0,monsterNames.length-1)];
  let gain = Math.floor(user.level*4)+rint(18,30);
  let hpLoss = rint(13,26);
  let goldGain = rint(32,80) + Math.floor(user.level*4.2);
  user.exp += gain;
  user.hp -= hpLoss; if(user.hp<1){user.hp=0;}
  user.gold += goldGain;
  let dropMsg = "", stoneMsg="", uniqueMsg="", loseMsg = "";
  let itemGot = null;
  if (Math.random() < 0.5) {
    let item = makeItem(true);
    if (addInv(item)) {
      dropMsg = `<br>아이템 획득! ${itemDisplay(item)}`;
      if(item.rarity=="유일") uniqueMsg = "<br><span style='color:#fa4242;'>유일 등급 아이템(또는 몬스터) 조우!</span>";
      itemGot = item;
    }
  }
  if(Math.random()<0.15){
    user.stones=(user.stones||0)+1;
    stoneMsg=`<br><span style="color:#77e;">강화석 1개를 획득했다!</span>`;
  }
  if(user.hp<=0){
    user.hp=1;
    let lost = [];
    if(Math.random()<0.2){
      let candidates = equipSlots.filter(s=>user.equip[s]);
      if(candidates.length){
        let lostSlot = candidates[rint(0,candidates.length-1)];
        let lostItem = user.equip[lostSlot];
        user.equip[lostSlot] = undefined;
        lost.push(lostItem.name);
      }
    }
    loseMsg = `<br><span class="fail-msg">[사망] ${lost.length?'장비 손실: '+lost.join(", "):'HP 1로 복귀'}</span>`;
    log(`[던전] <span class="monname">${mon}</span>와의 전투에서 패배!<br>HP 1로 복귀.${loseMsg}`);
  }else{
    log(`[던전] <span class="monname">${mon}</span>와의 전투 결과<br>
      경험치 +${gain}, HP -${hpLoss}, 골드 +${goldGain}${dropMsg}${stoneMsg}${uniqueMsg}`);
  }
  updateUser();
}
function levelupCheck(){
  while(user.exp>=expNeed(user.level) && user.level<999){
    user.exp -= expNeed(user.level);
    user.level++;
    statRandAdd(user.stats);
    user.maxhp += 5+rint(0,5);
    user.hp = user.maxhp;
    log(`[LEVEL UP!] Lv.${user.level}로 올랐습니다!`);
  }
}
function statRandAdd(stats){
  let idx = rint(0,stats.length-1);
  stats[idx]++;
}
function rint(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function makeItem(allowMyth) {
  let rate = allowMyth ? dungeonRate : rarityRate;
  let r = Math.random() * 100;
  let rarity = "일반";
  let acc = 0;
  for (let i=0;i<rate.length;i++) {
    acc += rate[i];
    if (r < acc) { rarity = rarityOrder[i]; break; }
  }
  let slot = equipSlots[rint(0, equipSlots.length-1)];
  let pool = slotTypePool[slot];
  let baseObj = pool[rint(0, pool.length-1)];
  let itemType = baseObj.name;
  let itemAttackType = baseObj.type || null;
  let prefix = prefixes[rint(0,prefixes.length-1)];
  let suffix = suffixes[rint(0,suffixes.length-1)];
  let name = "";
  let itemLevel = Math.max(1, Math.round(user.level * (0.7 + Math.random()*0.4)));
  if (rarity === "유일") {
    name = makeMythicName();
    prefix = null; suffix = null;
  } else {
    name = `${prefix} ${suffix}의 ${itemType}`;
  }
  let skillBase = null, skill = null;
  if (itemAttackType && skillPool[itemAttackType]) {
    skillBase = skillPool[itemAttackType][rint(0, skillPool[itemAttackType].length-1)];
    skill = prefix ? `${prefix} ${skillBase}` : skillBase;
  }
  let stat = [];
  let bonus = rarityBonus(rarity) + Math.floor(itemLevel/9);
  for (let i=0;i<5;i++) stat.push(rint(0, (i===0?4:2) + bonus));
  let atk=0, ratk=0, matk=0;
  if(itemAttackType=="근접") atk = rint(2, 8+bonus*2);
  if(itemAttackType=="원거리") ratk = rint(2, 8+bonus*2);
  if(itemAttackType=="마법") matk = rint(2, 8+bonus*2);
  let skillBonus = 1;
  if(prefix && prefix.includes("불타는")) skillBonus = 1.2;
  let trigger = skillTriggerRate[rarity] || 0.05;
  stat.push(Math.floor(atk * skillBonus));
  stat.push(Math.floor(ratk * skillBonus));
  stat.push(Math.floor(matk * skillBonus));
  return {
    name: name,
    rarity: rarity,
    slot: slot,
    stat: stat,
    type: itemType,
    attackType: itemAttackType,
    skill: skill,
    skillBase: skillBase,
    skillBonus: skillBonus,
    skillTrigger: trigger,
    enh: 0,
    itemLevel: itemLevel
  };
}
function makeMythicName(){
  const mythPrefix = ["아르카나의", "룬의", "잊혀진", "칼리버", "드래곤의", "운명의", "왕의", "카오스", "은하수의"];
  const mythMain = ["심판자", "전설", "창조자", "파멸자", "수호자", "심연", "영혼", "여명", "분노"];
  return `${mythPrefix[rint(0,mythPrefix.length-1)]} ${mythMain[rint(0,mythMain.length-1)]}`;
}
function rarityBonus(rarity){
  switch(rarity){
    case "일반": return 1;
    case "레어": return 2;
    case "유니크": return 3;
    case "에픽": return 4;
    case "레전더리": return 6;
    case "유일": return 10;
  }
  return 1;
}
function showChar() {
  let eqhtml = "";
  for(let slot of equipSlots){
    let eq = user.equip[slot];
    if(eq){
      eqhtml += `<div><b>${slot}:</b> <span class="ilv-txt">Lv.${eq.itemLevel||1}</span><span class="${rarityColors[eq.rarity]}">${enhanceLabel(eq)}${eq.name}</span> <span class="equip-bonus">[${itemStatDisplay(eq)}]</span>
      <button class="inv-btn" onclick="unequip('${slot}')">해제</button><button class="enhance-btn" onclick="showEnhance('equip','${slot}')">강화</button></div>`;
    } else {
      eqhtml += `<div><b>${slot}:</b> <span style="color:#888">비어있음</span></div>`;
    }
  }
  let weaponInfo = "";
  let weapon = user.equip["무기"];
  if(weapon){
    weaponInfo = `<br><b>🗡️ 장착 무기: ${enhanceLabel(weapon)}${weapon.name} (${weapon.type})</b>
    <br>💡 <b>스킬:</b> <span style="color:#ffd700">${weapon.skill || '-'}</span>
    <br><b>스킬 발동 확률:</b> ${(weapon.skillTrigger*100).toFixed(0)}%
    <br><b>공격력 종류:</b> ${weapon.attackType=="근접"?"ATK":weapon.attackType=="원거리"?"RATK":"MATK"}${weapon.skillBonus>1?" <span style='color:#ff5858'>[속성 강화]</span>":""}`;
  }else{
    weaponInfo = "<br><b>장착 무기 없음</b>";
  }
  log(`<b>[캐릭터]</b><br>
    <b>레벨:</b> ${user.level} / <b>환생:</b> ${user.rebirth} / <b>경험치:</b> ${user.exp}/${expNeed(user.level)}<br>
    <b>스탯:</b> ${user.stats.map((s,i)=>`${statNames[i]}:${s}`).join(" / ")}<br>
    <b>HP:</b> ${user.hp}/${user.maxhp}<br>
    <b>장착장비</b><br><div class="scroll-y">${eqhtml}</div>
    ${weaponInfo}
    <br><button class="inv-btn" onclick="updateUser();log('이전 화면으로 돌아감');">닫기</button>
  `);
}
function enhanceLabel(item) {
  return item.enh && item.enh > 0 ? `<span class="enh-lv">+${item.enh}</span> ` : '';
}
function unequip(slot) {
  if (!user.equip[slot]) return;
  addInv(user.equip[slot]);
  user.equip[slot] = undefined;
  showChar();
}
function showInv() {
  let invhtml = "";
  user.inv.forEach((item,i)=>{
    if(item.type){
      invhtml += `<div class="equipitem"><span class="ilv-txt">Lv.${item.itemLevel||1}</span><span class="${rarityColors[item.rarity]}">${enhanceLabel(item)}${item.name}</span>
      <span class="equip-bonus">[${itemStatDisplay(item)}]</span>
      <button class="inv-btn" onclick="equipItem(${i})">착용</button>
      <button class="inv-btn" onclick="removeInv(${i})">버리기</button>
      <button class="enhance-btn" onclick="showEnhance('inv',${i})">강화</button></div>`;
    } else {
      invhtml += `<div class="equipitem">${item.name || "아이템"}
      <button class="inv-btn" onclick="removeInv(${i})">버리기</button></div>`;
    }
  });
  if(!invhtml) invhtml="<div style='color:#888'>소지품이 없습니다.</div>";
  log(`<b>[소지품]</b> (${user.inv.length}/${inventoryLimit})<br><div class="scroll-y">${invhtml}</div>
    <button class="inv-btn" onclick="updateUser();log('이전 화면으로 돌아감');">닫기</button>`);
}
function removeInv(idx){ user.inv.splice(idx,1); showInv(); }
function equipItem(idx){
  let item=user.inv[idx];
  if(!item) return;
  if(user.equip[item.slot]) addInv(user.equip[item.slot]);
  user.equip[item.slot]=item;
  user.inv.splice(idx,1);
  showInv(); updateUser();
}
function addInv(item){
  if(user.inv.length>=inventoryLimit){log("소지품이 가득 찼다!"); return false;}
  user.inv.push(item); return true;
}
function itemDisplay(item){
  return `<span class="ilv-txt">Lv.${item.itemLevel||1}</span><span class="${rarityColors[item.rarity]}">${enhanceLabel(item)}${item.name}</span> <span class="equip-bonus">[${itemStatDisplay(item)}]</span>`;
}
function itemStatDisplay(item){
  let arr = [];
  for(let i=0;i<5;i++) arr.push(`${statNames[i]}+${item.stat[i]}`);
  arr.push(`ATK+${item.stat[5]}`);
  arr.push(`RATK+${item.stat[6]}`);
  arr.push(`MATK+${item.stat[7]}`);
  if(item.enh && item.enh>0) arr.push(`강화:${item.enh}`);
  return arr.join(' / ');
}
function showEnhance(where, arg) {
  let item;
  if(where=='inv') item = user.inv[arg];
  else if(where=='equip') item = user.equip[arg];
  if(!item || !item.type) return;
  let enh = item.enh || 0;
  let needStone = enhanceStoneNeed(enh+1);
  let prob = enhanceProb(enh+1);
  let msg = `<b>${enhanceLabel(item)}${item.name}</b><br>
    현재 강화: <span class="enh-lv">${enh}강</span><br>
    <b>다음 강화(+${enh+1}강)</b><br>
    필요 강화석: <b>${needStone}</b> (보유: ${user.stones||0})<br>
    성공 확률: <b>${(prob*100).toFixed(1)}%</b><br>
    <button class="enhance-btn" onclick="doEnhance('${where}',${JSON.stringify(arg)})">강화 시도</button>
    <button class="inv-btn" onclick="updateUser();log('이전 화면으로 돌아감');">취소</button>
    <div style="margin-top:14px;color:#aaa;font-size:13px;">* 실패시 아이템은 파괴됩니다.</div>`;
  log(msg);
}
function enhanceStoneNeed(lv) {
  if(lv<=0) return 0;
  if(lv==1) return 1;
  if(lv==2) return 2;
  if(lv==3) return 4;
  if(lv==4) return 8;
  if(lv>=5 && lv<10) return 20*Math.pow(2,lv-5);
  if(lv>=10 && lv<15) return 20*Math.pow(2,5)*Math.pow(3,lv-10);
  if(lv>=15) return 20*Math.pow(2,5)*Math.pow(3,5)*Math.pow(4,lv-15);
  return 999999;
}
function enhanceProb(lv) {
  if(lv<=4) return 1;
  if(lv<=6) return 0.4;
  if(lv<=8) return 0.2;
  if(lv<=10) return 0.1;
  if(lv<=12) return 0.05;
  if(lv<=14) return 0.025;
  if(lv<=16) return 0.01;
  if(lv<=18) return 0.007;
  if(lv==19) return 0.004;
  if(lv==20) return 0.002;
  return 0;
}
function doEnhance(where, arg) {
  let item;
  if(where=='inv') item = user.inv[arg];
  else if(where=='equip') item = user.equip[arg];
  if(!item || !item.type) return;
  let enh = item.enh || 0;
  let needStone = enhanceStoneNeed(enh+1);
  let prob = enhanceProb(enh+1);
  if((user.stones||0)<needStone){
    log(`<span class="fail-msg">강화석이 부족합니다! (${needStone} 필요)</span>`);
    return;
  }
  if(enh>=20){
    log(`<span class="fail-msg">최대 +20강입니다.</span>`);
    return;
  }
  user.stones -= needStone;
  if(Math.random()<prob){
    item.enh = (item.enh||0)+1;
    for(let i=0;i<item.stat.length;i++){
      item.stat[i] += Math.max(1,Math.floor((item.enh)/3));
    }
    log(`<span class="succ-msg">강화 성공! +${item.enh}강이 되었습니다!</span>`);
  }else{
    if(where=='inv') user.inv.splice(arg,1);
    else if(where=='equip') user.equip[arg]=undefined;
    log(`<span class="fail-msg">강화 실패! 아이템이 파괴되었습니다!</span>`);
  }
  updateUser();
}
function showShop() {
  let html = `<div class="shop-title">장비상점 - 판매(골드 획득)</div>
  <div class="scroll-y">`;
  for(let slot of equipSlots){
    let eq = user.equip[slot];
    if(eq){
      html += `<div class="shop-item"><b>[${slot}]</b> <span class="ilv-txt">Lv.${eq.itemLevel||1}</span><span class="${rarityColors[eq.rarity]}">${enhanceLabel(eq)}${eq.name}</span>
      <span class="equip-bonus">[${itemStatDisplay(eq)}]</span>
      <button class="inv-btn" onclick="sellItem('equip','${slot}')">판매</button></div>`;
    }
  }
  user.inv.forEach((item,i)=>{
    if(item.type){
      html += `<div class="shop-item"><span class="ilv-txt">Lv.${item.itemLevel||1}</span><span class="${rarityColors[item.rarity]}">${enhanceLabel(item)}${item.name}</span>
      <span class="equip-bonus">[${itemStatDisplay(item)}]</span>
      <button class="inv-btn" onclick="sellItem('inv',${i})">판매</button></div>`;
    }
  });
  html += `</div><br><button class="inv-btn" onclick="showTown()">마을로 돌아가기</button>`;
  log(html);
}
function sellItem(where, arg) {
  let item;
  if(where=='inv') item = user.inv[arg];
  else if(where=='equip') item = user.equip[arg];
  if(!item || !item.type) return;
  let gold = calcSellGold(item);
  if(where=='inv') user.inv.splice(arg,1);
  else if(where=='equip') user.equip[arg]=undefined;
  user.gold += gold;
  updateUser();
  log(`<span class="succ-msg">${enhanceLabel(item)}${item.name}을(를) 판매하고 <b>${gold}골드</b>를 획득!</span>`);
  setTimeout(showShop, 1200);
}
function calcSellGold(item){
  let base = 20 + item.stat.reduce((a,b)=>a+b,0)*6 + (item.enh||0)*50 + (item.itemLevel||1)*10;
  switch(item.rarity){
    case "레어": base*=2; break;
    case "유니크": base*=3; break;
    case "에픽": base*=5; break;
    case "레전더리": base*=10; break;
    case "유일": base*=30; break;
  }
  return Math.floor(base);
}
function showTown(){
  log(`<b>[마을]</b><br>
    <button class="inv-btn" onclick="innRest()">여관(휴식)</button>
    <button class="inv-btn" onclick="showShop()">장비상점(판매)</button>
    <button class="inv-btn" onclick="rebirth()">환생의 집</button>
    <button class="inv-btn" onclick="updateUser();log('이전 화면으로 돌아감');">닫기</button>`);
}
function innRest(){
  let cost=20+user.level*5;
  if(user.gold<cost){log("골드가 부족합니다.");return;}
  user.gold-=cost; user.hp=user.maxhp;
  log(`여관에서 휴식 후 HP 전부 회복! (${cost}골드 소모)<br><button class='inv-btn' onclick='showTown()'>돌아가기</button>`);
  updateUser();
}
function rebirth(){
  if(user.level<999){log("레벨 999 달성 시에만 환생 가능!<br><button class='inv-btn' onclick='showTown()'>돌아가기</button>");return;}
  if(!confirm("환생 시 레벨/스탯/장비가 초기화됩니다. 진행할까요?")) return;
  user.level=1; user.exp=0; user.gold=100;
  user.stats=user.stats.map(x=>1+user.rebirth*10);
  user.statmax=9999; user.rebirth+=1; user.hp=30; user.maxhp=30; user.equip={}; user.inv=[]; user.stones=0;
  log("환생 완료! 기본 능력치 +10이 부여되었습니다.<br><button class='inv-btn' onclick='showTown()'>돌아가기</button>");
  updateUser();
}
</script>
</body>
</html>
